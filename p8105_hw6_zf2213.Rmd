---
title: "P8105 Homework6"
author: 'Zanis Fang, UID: ZF2213'
date: "11/16/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(mgcv)
```

### Problem 1

**Data Cleaning:**

```{r data_cleaning}
# read data from github repo
homicide <- read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") %>% 
	# create city_state variable
	unite(col = "city_state", city:state, sep = ", ", remove = FALSE) %>% 
	# create a variable for resolved
	mutate(resolved = as.numeric(disposition %in% "Closed by arrest")) %>%
	# select cities with victim race
	filter(!(city_state %in% c("Dallas, TX",
														 "Phoenix, AZ",
														 "Kansas City, MO",
														 "Tulsa, AL"))) %>%
	# change victim to numeric variable, race into factors
	mutate(victim_age = as.numeric(victim_age),
				 victim_race = if_else(victim_race == "White", "white", "non-white"),
				 victim_race = fct_relevel(victim_race, "white")) 
```

**Test logistic regression on Baltimore, MD:**

```{r logistic_regression_test}
# get baltimore, MD
glm_test <- homicide %>% filter(city_state == "Baltimore, MD")
# fit logistic model
glm_result <- glm(resolved ~ victim_age + victim_sex + victim_race, data = glm_test)
# tidy the regression output
result_test <- broom::tidy(glm_result)
# 
result_test <- result_test %>%
	janitor::clean_names() %>%
	mutate(conf_upper = estimate + qnorm(0.975) * std_error,
				 conf_lower = estimate - qnorm(0.975) * std_error)

result_test %>%
	filter(term == "victim_racenon-white") %>% 
	select(estimate, conf_upper, conf_lower) %>% 
	knitr::kable()
```

**Logistic regression on all cities:**

```{r regression_all_cities}
glm_all_cities <- homicide %>% 
	select(city_state, resolved, victim_age, victim_sex, victim_race) %>%
	group_by(city_state) %>% 
	nest(resolved, victim_age, victim_sex, victim_race) %>%
	# get logistic regression model
	mutate(glm_model = map(.x = data,
												 .f = ~ broom::tidy(glm(resolved ~
												 											 	victim_age + 
												 											 	victim_sex +
												 											 	victim_race,
												 											 data = .x)))) %>%
	select(city_state, glm_model) %>%
	unnest() %>%
	janitor::clean_names() %>%
	# get confidence interval
	mutate(conf_upper = estimate + qnorm(0.975) * std_error,
				 conf_lower = estimate - qnorm(0.975) * std_error) %>%
	filter(term == "victim_racenon-white") %>%
	mutate(estimate = exp(estimate),
				 conf_upper = exp(conf_upper),
				 conf_lower = exp(conf_lower))
```

**Plot odds ratios with confidence interval:**

```{r plot}
glm_all_cities %>% 
	ggplot(aes(x = fct_reorder(city_state, estimate), y = estimate)) +
	geom_point() +
	geom_errorbar(aes(ymin = conf_lower, ymax = conf_upper), position = "dodge") +
	labs(
		x = "City",
		y = "Odds Ratio"
	) +
	theme(
		axis.text.x = element_text(angle = 90)
	)
```

**Comments:**
Highest non-white vs white odds ratio of solved cases is Tempa, FL, and lowest one is Boston, MA. Most cities have odds ratio. Nashville, TN has largest standard error and Chicago, IL has lowest standard error. Generally speaking, the cases with non-white victims have lower solved cases odds ratios.

### Problem 2

```{r}
birthweight <- read_csv("./birthweight.csv") %>% 
# recode the factor variables, set controls
	mutate(babysex = fct_recode(as.factor(babysex), "female" = "2", "male" = "1"),
				 babysex = fct_relevel(babysex, "female"),
				 frace = fct_recode(as.factor(frace),
				 									 "white" = "1", "non_white" = "2", "non_white" = "3",
				 									 "non_white" = "4", "non_white" = "8"),
				 frace = fct_relevel(frace, "non_white"),
				 malform = fct_recode(as.factor(malform), "absent" = "0", "present" = "1"),
				 malform = fct_relevel(malform, "absent"),
				 mrace = fct_recode(as.factor(mrace),
				 									 "white" = "1", "non_white" = "2", "non_white" = "3",
				 									 "non_white" = "4"),
				 mrace = fct_relevel(mrace, "non_white")
				 )

birthweight_full <- lm(data = birthweight, formula = bwt ~ .)
birthweight %>% skimr::skim()




```






```{r }
source('~/Documents/P8130 Biostatistical methods I/homework 5/stepwise_reg.r')

birthweight_lm <- stepwise_reg(data = birthweight, y = "bwt", in_alpha = 0.01, out_alpha = 0.015)

subset_birthweight <-
	birthweight %>%
	select(bwt, bhead, blength, mrace, delwt, gaweeks, smoken, ppbmi, babysex, mheight)

```

Do a stepwise regression, test each candidates if its p value less than predefined alpha level.

```{r}
birthweight %>%
	modelr::add_predictions(model = birthweight_lm[[1]]) %>% 
	modelr::add_residuals(model = birthweight_lm[[1]]) %>% 
	ggplot(aes(x = pred, y = resid)) +
	  geom_point()
```

```{r}






bwt_diy <- "bwt ~ bhead + blength + mrace + delwt + gaweeks + smoken + ppbmi + babysex"
bwt_len_ga <- "bwt ~ blength + gaweeks"
bwt_head_len_sex <- "bwt ~ bhead * blength * babysex"


cv_df <- crossv_mc(data = birthweight, n = 100)

cv_df %>%
	mutate(train = map(train, as_tibble),
				 test = map(test, as_tibble)) %>%
	mutate(lm_diy = map(.x = train,
											.f = ~lm(formula = as.formula(bwt_diy),
															 data = .x)),
				 lm_len_ga = map(.x = train,
				 								.f = ~lm(formula = as.formula(bwt_len_ga),
				 												 data = .x)),
				 lm_head_len_sex = map(.x = train,
				 											.f = ~lm(formula = as.formula(bwt_head_len_sex),
				 															 data = .x))
				 )
	
	


```









