---
title: "P8105 Homework6"
author: 'Zanis Fang, UID: ZF2213'
date: "11/16/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

### Problem 1


```{r}
# read data from github repo
homicide <- read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") %>% 
	# create city_state variable
	unite(col = "city_state", city:state, sep = ", ", remove = FALSE) %>% 
	# create a variable for resolved
	mutate(resolved = disposition %in% "Closed by arrest") %>%
	# select cities with victim race
	filter(!(city_state %in% c("Dallas, TX",
														 "Phoenix, AZ",
														 "Kansas City, MO",
														 "Tulsa, AL"))) %>%
	# change victim to numeric variable, race into factors
	mutate(victim_age = as.numeric(victim_age),
				 victim_race = if_else(victim_race == "White", "white", "non-white"),
				 victim_race = fct_relevel(victim_race, "white")) 


glm_test <- homicide %>%
	filter(city_state == "Baltimore, MD")
glm_result <- glm(resolved ~ victim_age + victim_sex + victim_race, data = glm_test)
glm_conf <- as_tibble(confint(glm_result))
glm_result <- broom::tidy(glm_result)
result_test <- as_tibble(cbind(glm_result, glm_conf)) %>%
	janitor::clean_names() %>%
	mutate(calc_upper = estimate + qnorm(0.975) * std_error,
				 calc_lower = estimate - qnorm(0.975) * std_error)

glm_all_cities <- homicide %>% 
	select(city_state, resolved, victim_age, victim_sex, victim_race) %>%
	group_by(city_state) %>% 
	nest(resolved, victim_age, victim_sex, victim_race) %>%
	# get logistic regression model
	mutate(glm_model = map(.x = data,
												 .f = ~ broom::tidy(glm(resolved ~
												 											 	victim_age + 
												 											 	victim_sex +
												 											 	victim_race,
												 											 data = .x)))) %>%
	select(city_state, glm_model) %>%
	unnest() %>%
	janitor::clean_names() %>% 
	# get confidence interval
	mutate(conf_upper = estimate + qnorm(0.975) * std_error,
				 conf_lower = estimate - qnorm(0.975) * std_error) %>%
	filter(term == "victim_racenon-white") %>%
	mutate(estimate = exp(estimate),
				 conf_upper = exp(conf_upper),
				 conf_lower = exp(conf_lower))

glm_all_cities %>% 
	ggplot(aes(x = fct_reorder(city_state, estimate), y = estimate)) +
	geom_point() +
	geom_errorbar(aes(ymin = conf_lower, ymax = conf_upper), position = "dodge") +
	labs(
		x = "City",
		y = "Odds Ratio"
	) +
	theme(
		axis.text.x = element_text(angle = 90)
	)
	


```


